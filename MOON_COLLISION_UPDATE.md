# 月の衝突判定改善 - 実装完了

## 実装日
2025年10月5日

## 追加・変更した機能

### ✅ 1. 発射前の月にも当たり判定を追加

**変更前:**
- 発射済み（`isLaunched = true`）の月のみ地球に当たり判定があった
- 発射前の月（周回中）は無敵状態だった

**変更後:**
- **発射前の月にも当たり判定**が有効になりました
- 周回中の月も攻撃を受けて破壊されます
- より戦略的なゲームプレイが可能に

**技術的変更:**
```java
// Moon.pde の checkCollision() メソッド

// 変更前
boolean checkCollision(Earth earth) {
  if (!isLaunched) return false;  // 発射前は判定しない
  // ...
}

// 変更後
boolean checkCollision(Earth earth) {
  // 発射前でも当たり判定を実施（isLaunchedチェックを削除）
  float distance = dist(x, y, earth.x, earth.y);
  float size = radius + chargeLevel * 5;
  return distance < (size + earth.radius);
}
```

---

### ✅ 2. 月同士の衝突でどちらも破壊

**変更前:**
- 月同士の衝突判定が存在しなかった
- 月が月をすり抜けていた

**変更後:**
- **月同士が衝突すると両方とも破壊**されます
- 衝突地点で爆発エフェクトが発生
- ヒット音が再生される
- 画面振動とヒットストップが発生

**新規追加メソッド:**
```java
// Moon.pde
boolean checkCollisionWithMoon(Moon otherMoon) {
  // 発射済みの月との衝突のみ判定
  if (!this.isLaunched && !otherMoon.isLaunched) return false;
  
  float distance = dist(x, y, otherMoon.x, otherMoon.y);
  float thisSize = radius + chargeLevel * 5;
  float otherSize = otherMoon.radius + otherMoon.chargeLevel * 5;
  return distance < (thisSize + otherSize);
}
```

**衝突処理:**
```java
// Game.pde の updatePlaying() 内
// 月同士の衝突判定（どちらも破壊）
if (earth.moon.checkCollisionWithMoon(other.moon)) {
  earth.moon.reset();       // 1つ目の月をリセット
  other.moon.reset();       // 2つ目の月をリセット
  
  // 衝突地点でエフェクト
  float collisionX = (earth.moon.x + other.moon.x) / 2;
  float collisionY = (earth.moon.y + other.moon.y) / 2;
  particleManager.createExplosion(collisionX, collisionY, color(255, 200, 100), 15);
  SoundManager.playHit();
  
  // ヒットストップと画面振動
  hitStopTimer = 8;
  shakeTimer = 15;
}
```

---

### ✅ 3. 水星のクールタイム中は水を付与しない

**確認結果:**
- **既に実装済み**でした！
- `Mercury.pde` の `giveWater()` メソッドで、`hasWater` が `true` の場合のみ水を付与
- クールタイム中（`hasWater = false`）は月が当たっても何も起こりません

**実装コード:**
```java
// Mercury.pde
void giveWater(Moon moon) {
  // 水星に水がある場合のみ、水を付与
  if (hasWater) {
    if (!moon.hasWater) {
      moon.hasWater = true;
      SoundManager.playWaterSplash();
    }
    hasWater = false;
    waterTimer = 0; // タイマーリセット
  }
  // hasWater == false の場合は何もしない（要望通り）
}
```

---

## 変更されたファイル

### 1. `src/Moon.pde`

#### 変更したメソッド
- `checkCollision(Earth earth)`: 発射前の月でも当たり判定を行うように修正

#### 追加したメソッド
- `checkCollisionWithMoon(Moon otherMoon)`: 月同士の衝突判定（新規）

### 2. `src/Game.pde`

#### 変更したメソッド
- `updatePlaying()`: 月同士の衝突判定処理を追加

---

## ゲームプレイへの影響

### 戦略性の向上

#### Before（以前）
- 発射前の月は無敵（周回中は安全）
- 月同士はすり抜ける
- チャージ中は攻撃を受けない

#### After（今回）
- ✨ 発射前の月も攻撃を受ける（周回中も危険）
- ✨ 月同士が衝突すると相打ち
- ✨ チャージ中も防御が必要
- ✨ より緊張感のある戦闘

### 新しい戦術

1. **防御的チャージ**
   - 敵の月が飛んでくる時はチャージを中断
   - 安全な位置でチャージを開始

2. **相打ち戦術**
   - 敵の月に自分の月をぶつけて相殺
   - 防御的な月の使い方が可能に

3. **狙撃戦術**
   - 周回中の月を狙撃できる
   - タイミングを見計らった精密な攻撃

4. **水星の価値向上**
   - クールタイム中は無駄撃ちになる
   - 水星への攻撃タイミングがより重要に

---

## 衝突判定の詳細

### 地球への衝突（月 → 地球）

**判定条件:**
- 月と地球の距離が一定以下

**結果:**
- 地球が破壊される
- 月がリセットされる
- ヒットストップ（10フレーム）
- 画面振動（20フレーム）

### 月同士の衝突（月 ↔ 月）

**判定条件:**
- どちらか一方以上が発射済み
- 月同士の距離が一定以下

**結果:**
- **両方の月がリセット**される（相打ち）
- 衝突地点で爆発エフェクト（オレンジ色）
- ヒット音が再生
- ヒットストップ（8フレーム）
- 画面振動（15フレーム）

### 水星への衝突（月 → 水星）

**判定条件:**
- 月が発射済み
- 月と水星の距離が一定以下

**結果（水星に水がある場合）:**
- 月が水を獲得
- 水星の水がなくなる
- クールタイム開始（3秒）
- 水しぶきエフェクト

**結果（クールタイム中）:**
- **何も起こらない**（要望通り）
- 月はそのまま通過

---

## 衝突判定の優先順位

ゲームループ内での衝突判定の順序:

1. **太陽との衝突** → 月が燃える
2. **水星との衝突** → 水を獲得（水がある場合のみ）
3. **金星との衝突** → 月がリセット
4. **地球との衝突** → 地球が破壊
5. **月同士の衝突** → 両方リセット（相打ち）

---

## エフェクトとフィードバック

### 月同士の衝突時

**視覚的フィードバック:**
- オレンジ色の爆発エフェクト（15パーティクル）
- 画面振動（15フレーム）
- ヒットストップ（8フレーム）

**聴覚的フィードバック:**
- ヒット音（`hit.mp3`）

**位置:**
- 2つの月の中間地点で爆発

---

## テストケース

### 1. 発射前の月への攻撃
- [ ] 周回中の月に他の月が当たると破壊される
- [ ] チャージ中の月も破壊される
- [ ] 破壊された月がリセットされる

### 2. 月同士の衝突
- [ ] 発射済みの月同士が当たると両方リセットされる
- [ ] 衝突地点で爆発エフェクトが発生
- [ ] ヒット音が再生される
- [ ] 画面振動が発生する

### 3. 水星のクールタイム
- [ ] クールタイム中は月が当たっても水を獲得しない
- [ ] 水があるときのみ水を獲得できる
- [ ] クールタイムタイマーが正しく表示される

---

## バランス調整

### ヒットストップ・画面振動

| 衝突タイプ | ヒットストップ | 画面振動 |
|----------|--------------|---------|
| 月 → 地球 | 10フレーム | 20フレーム |
| 月 ↔ 月 | 8フレーム | 15フレーム |

月同士の衝突は地球破壊よりもやや軽めの演出になっています。

---

## 今後の改善案

### 追加機能
- [ ] 月同士の衝突時に跳ね返る（破壊ではなく）
- [ ] チャージレベルによる衝突判定の変化
- [ ] 水を持った月同士の衝突で特殊エフェクト

### バランス調整
- [ ] 発射前の月の防御力を調整可能に
- [ ] 月同士の衝突ダメージを設定可能に
- [ ] クールタイムの長さを調整

### ビジュアル改善
- [ ] 月同士の衝突エフェクトをより派手に
- [ ] 発射前の月に防御シールド表示
- [ ] クールタイム中の水星の見た目を変更

---

## まとめ

3つの要望をすべて実装しました:

1. ✅ **発射前の月にも当たり判定** - より緊張感のある戦闘
2. ✅ **月同士の衝突で両方破壊** - 相打ちシステムで戦略性向上
3. ✅ **水星のクールタイム中は水なし** - 既に実装済みで正常動作

これにより、ゲームの戦略性が大幅に向上し、より緊張感のある対戦が楽しめるようになりました！
